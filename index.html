<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>সীরাতুন নবী ﷺ প্রতিযোগিতা</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #d1fae5 0%, #99f6e4 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            padding: 40px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #065f46;
            font-size: 2.5em;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #6b7280;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .info-box {
            background: #d1fae5;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .info-box h3 {
            color: #065f46;
            margin-bottom: 15px;
        }
        
        .info-box ul {
            list-style: none;
            padding: 0;
        }
        
        .info-box li {
            color: #374151;
            margin: 10px 0;
            padding-left: 25px;
        }
        
        .code-box {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }
        
        .code-label {
            color: white;
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .verification-code {
            font-size: 20px;
            font-weight: bold;
            color: white;
            letter-spacing: 1px;
            font-family: 'Courier New', monospace;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            margin: 15px 0;
            word-break: break-all;
            line-height: 1.6;
        }
        
        .code-instruction {
            color: white;
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.9;
        }
        
        .whatsapp-box {
            background: #dcf8c6;
            border: 2px solid #25D366;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        .whatsapp-box h3 {
            color: #075e54;
            margin-bottom: 10px;
        }
        
        .decoder-box {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .decoder-box h3 {
            color: #1e40af;
            margin-bottom: 15px;
        }
        
        .decode-input {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .decode-input input {
            flex: 1;
            padding: 15px;
            border: 2px solid #3b82f6;
            border-radius: 10px;
            font-size: 18px;
            text-transform: none;
            letter-spacing: 0px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }
        
        .decode-result {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            display: none;
        }
        
        .decode-result.show {
            display: block;
        }
        
        .result-item {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #10b981;
            padding-left: 15px;
            font-size: 16px;
        }
        
        .auto-save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .auto-save-indicator.show {
            opacity: 1;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            color: #374151;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        input, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #10b981;
        }
        
        .btn {
            width: 100%;
            padding: 18px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #10b981;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #d1d5db;
            color: #374151;
            padding: 12px 24px;
            width: auto;
        }
        
        .btn-secondary:hover {
            background: #9ca3af;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }
        
        .btn-success {
            background: #059669;
            color: white;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        .btn-whatsapp {
            background: #25D366;
            color: white;
        }
        
        .btn-whatsapp:hover {
            background: #128C7E;
        }
        
        .btn-decode {
            background: #3b82f6;
            color: white;
            padding: 15px 30px;
            width: auto;
        }
        
        .btn-decode:hover {
            background: #2563eb;
        }
        
        .timer-box {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .timer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .timer {
            color: #ef4444;
            font-size: 24px;
            font-weight: bold;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s;
        }
        
        .question-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .question-badge {
            display: inline-block;
            background: #d1fae5;
            color: #065f46;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .question-text {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 20px;
        }
        
        .option {
            width: 100%;
            padding: 18px;
            margin: 10px 0;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            background: white;
            text-align: right;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .option:hover {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .option.selected {
            border-color: #10b981;
            background: #d1fae5;
        }
        
        .nav-buttons {
            display: flex;
            gap: 15px;
        }
        
        .nav-buttons button {
            flex: 1;
        }
        
        .success-icon {
            text-align: center;
            font-size: 80px;
            margin-bottom: 20px;
        }
        
        .success-message {
            text-align: center;
        }
        
        .success-message h2 {
            color: #065f46;
            font-size: 32px;
            margin-bottom: 15px;
        }
        
        .success-message p {
            color: #6b7280;
            font-size: 18px;
            margin: 10px 0;
        }
        
        .admin-link {
            text-align: center;
            margin-top: 30px;
        }
        
        .admin-link button {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .admin-link button:hover {
            color: #374151;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .export-buttons button {
            flex: 1;
            min-width: 150px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        thead {
            background: #10b981;
            color: white;
        }
        
        th, td {
            padding: 15px;
            text-align: center;
        }
        
        th {
            font-weight: bold;
        }
        
        tbody tr {
            border-bottom: 1px solid #e5e7eb;
        }
        
        tbody tr:hover {
            background: #f9fafb;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .badge-green {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-red {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .badge-gray {
            background: #f3f4f6;
            color: #374151;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .hidden {
            display: none;
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .card {
                padding: 20px;
                border-radius: 15px;
            }
            
            .verification-code {
                font-size: 14px;
                letter-spacing: 0px;
                word-break: break-all;
            }
            
            .timer {
                font-size: 18px;
            }
            
            .timer-box {
                padding: 15px;
            }
            
            .question-card {
                padding: 20px;
            }
            
            .question-text {
                font-size: 18px;
            }
            
            .option {
                padding: 15px;
                font-size: 15px;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .nav-buttons button {
                width: 100%;
            }
            
            .auto-save-indicator {
                top: 10px;
                right: 10px;
                padding: 8px 15px;
                font-size: 12px;
            }
            
            .admin-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .export-buttons button {
                width: 100%;
            }
            
            .decode-input {
                flex-direction: column;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 4px;
            }
            
            .container {
                max-width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5em;
            }
            
            .subtitle {
                font-size: 14px;
            }
            
            .info-box {
                padding: 15px;
            }
            
            .info-box li {
                font-size: 14px;
            }
            
            .question-text {
                font-size: 16px;
            }
            
            .btn {
                padding: 15px;
                font-size: 16px;
            }
            
            .success-icon {
                font-size: 60px;
            }
            
            .success-message h2 {
                font-size: 24px;
            }
            
            .success-message p {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="autoSaveIndicator" class="auto-save-indicator">✓ সংরক্ষিত</div>
    <div id="app"></div>

    <script>
        // WhatsApp নম্বর (এখানে আপনার নম্বর দিন)
        const WHATSAPP_NUMBER = '8801712345678'; // এই নম্বরটি পরিবর্তন করুন
        
        // Encoding/Decoding system - BACKGROUND mapping
        // B=0, A=1, C=2, K=3, G=4, R=5, O=6, U=7, N=8, D=9
        const ENCODE_MAP = ['B', 'A', 'C', 'K', 'G', 'R', 'O', 'U', 'N', 'D'];
        
        // For decoding (letter to number)
        function decodeChar(char) {
            const map = {'B':0, 'A':1, 'C':2, 'K':3, 'G':4, 'R':5, 'O':6, 'U':7, 'N':8, 'D':9};
            return map[char];
        }
        
        // Base64 encode/decode functions (UTF-8 safe)
        function base64Encode(str) {
            try {
                // Convert to UTF-8 bytes then to base64
                const utf8Bytes = new TextEncoder().encode(str);
                let binary = '';
                utf8Bytes.forEach(byte => binary += String.fromCharCode(byte));
                return btoa(binary);
            } catch (e) {
                console.error('Encode error:', e);
                return '';
            }
        }
        
        function base64Decode(str) {
            try {
                // Decode base64 then convert from UTF-8 bytes
                const binary = atob(str);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    bytes[i] = binary.charCodeAt(i);
                }
                return new TextDecoder().decode(bytes);
            } catch (e) {
                console.error('Decode error:', e, 'for string:', str);
                return null;
            }
        }
        
        // Generate verification code with ALL information encoded
        function generateVerificationCode(correct, wrong, unanswered, phone, name, timeTaken) {
            // Part 1: Encode name and phone (Base64)
            const namePhone = `${name}|${phone}`;
            const encodedNamePhone = base64Encode(namePhone);
            
            // Part 2: Result code (BACKGROUND encoding)
            const c = ENCODE_MAP[correct] || 'B';
            const w = ENCODE_MAP[wrong] || 'B';
            const u = ENCODE_MAP[unanswered] || 'B';
            const resultCode = `${c}${w}${u}`;
            
            // Part 3: Time code (মিনিট এবং সেকেন্ড encode)
            const timeMatch = timeTaken.match(/(\d+):(\d+)/);
            if (timeMatch) {
                const mins = parseInt(timeMatch[1]);
                const secs = parseInt(timeMatch[2]);
                
                // মিনিট encode (2 digit)
                const min1 = ENCODE_MAP[Math.floor(mins / 10)] || 'B';
                const min2 = ENCODE_MAP[mins % 10] || 'B';
                
                // সেকেন্ড encode (2 digit)
                const sec1 = ENCODE_MAP[Math.floor(secs / 10)] || 'B';
                const sec2 = ENCODE_MAP[secs % 10] || 'B';
                
                const timeCode = `${min1}${min2}${sec1}${sec2}`;
                
                // Final format: ENCODED_NAME_PHONE-RESULT-TIME
                return `${encodedNamePhone}-${resultCode}-${timeCode}`;
            }
            
            return `${encodedNamePhone}-${resultCode}-BBBB`;
        }
        
        // Decode verification code to get all information
        function decodeVerificationCode(code) {
            try {
                console.log('[DECODE] Starting decode for:', code);
                
                const parts = code.split('-');
                console.log('[DECODE] Split parts:', parts, 'Length:', parts.length);
                
                if (parts.length !== 3) {
                    console.log('[DECODE] Invalid parts length:', parts.length);
                    return null;
                }
                
                // Part 1: Decode name and phone
                console.log('[DECODE] Part 0 (base64):', parts[0]);
                const namePhone = base64Decode(parts[0]);
                console.log('[DECODE] Decoded namePhone:', namePhone);
                
                if (!namePhone) {
                    console.log('[DECODE] Failed to decode namePhone');
                    return null;
                }
                
                const nameParts = namePhone.split('|');
                console.log('[DECODE] Split nameParts:', nameParts, 'Length:', nameParts.length);
                
                if (nameParts.length !== 2) {
                    console.log('[DECODE] Invalid nameParts length:', nameParts.length);
                    return null;
                }
                
                const name = nameParts[0];
                const phone = nameParts[1];
                console.log('[DECODE] Name:', name, 'Phone:', phone);
                
                // Part 2: Decode result
                const resultPart = parts[1];
                console.log('[DECODE] Result part:', resultPart);
                
                if (resultPart.length !== 3) {
                    console.log('[DECODE] Invalid result part length:', resultPart.length);
                    return null;
                }
                
                const correct = decodeChar(resultPart[0]);
                const wrong = decodeChar(resultPart[1]);
                const unanswered = decodeChar(resultPart[2]);
                console.log('[DECODE] Results - Correct:', correct, 'Wrong:', wrong, 'Unanswered:', unanswered);
                
                if (correct === undefined || wrong === undefined || unanswered === undefined) {
                    console.log('[DECODE] Invalid result chars');
                    return null;
                }
                
                // Part 3: Decode time
                const timePart = parts[2];
                console.log('[DECODE] Time part:', timePart);
                
                if (timePart.length !== 4) {
                    console.log('[DECODE] Invalid time part length:', timePart.length);
                    return null;
                }
                
                const min1 = decodeChar(timePart[0]);
                const min2 = decodeChar(timePart[1]);
                const sec1 = decodeChar(timePart[2]);
                const sec2 = decodeChar(timePart[3]);
                console.log('[DECODE] Time digits - min1:', min1, 'min2:', min2, 'sec1:', sec1, 'sec2:', sec2);
                
                if (min1 === undefined || min2 === undefined || 
                    sec1 === undefined || sec2 === undefined) {
                    console.log('[DECODE] Invalid time chars');
                    return null;
                }
                
                const minutes = (min1 * 10) + min2;
                const seconds = (sec1 * 10) + sec2;
                const time = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                console.log('[DECODE] Final time:', time);
                
                const result = {
                    name: name,
                    phone: phone,
                    correct: correct,
                    wrong: wrong,
                    unanswered: unanswered,
                    time: time,
                    code: code
                };
                
                console.log('[DECODE] Successfully decoded, returning:', result);
                return result;
            } catch (e) {
                console.error('[DECODE] Error:', e);
                return null;
            }
        }
        
        // Decode verification code
        function decodeVerificationCode(code) {
            try {
                // Format: R1-CWU-R2PHONE
                // উদাহরণ: K-OCB-G45
                const parts = code.toUpperCase().split('-');
                if (parts.length !== 3) {
                    return null;
                }
                
                // মাঝের অংশ থেকে result নিব
                const resultPart = parts[1]; // যেমন: OCB
                if (resultPart.length !== 3) {
                    return null;
                }
                
                const correct = decodeChar(resultPart[0]);
                const wrong = decodeChar(resultPart[1]);
                const unanswered = decodeChar(resultPart[2]);
                
                if (correct === undefined || wrong === undefined || unanswered === undefined) {
                    return null;
                }
                
                return {
                    correct: correct,
                    wrong: wrong,
                    unanswered: unanswered,
                    code: code
                };
            } catch (e) {
                return null;
            }
        }
        
        // প্রশ্ন ডাটা
        const QUESTIONS = [
            {
                id: 1,
                type: 'mcq',
                question: 'রাসূলুল্লাহ ﷺ কোন সালে জন্মগ্রহণ করেন?',
                options: ['৫৭০ খ্রিস্টাব্দ', '৫৬০ খ্রিস্টাব্দ', '৫৮০ খ্রিস্টাব্দ', '৫৯০ খ্রিস্টাব্দ'],
                correctAnswer: 0
            },
            {
                id: 2,
                type: 'mcq',
                question: 'রাসূলুল্লাহ ﷺ এর পিতার নাম কী?',
                options: ['আবু তালিব', 'আবদুল্লাহ', 'আবদুল মুত্তালিব', 'আবু বকর'],
                correctAnswer: 1
            },
            {
                id: 3,
                type: 'mcq',
                question: 'রাসূলুল্লাহ ﷺ এর দুধ মাতার নাম কী?',
                options: ['আমিনা', 'হালিমা', 'খাদিজা', 'আয়িশা'],
                correctAnswer: 1
            },
            {
                id: 4,
                type: 'mcq',
                question: 'প্রথম কোন মহিলা ইসলাম গ্রহণ করেন?',
                options: ['আয়িশা রা.', 'ফাতিমা রা.', 'খাদিজা রা.', 'হাফসা রা.'],
                correctAnswer: 2
            },
            {
                id: 5,
                type: 'mcq',
                question: 'হিজরতের সময় রাসূলুল্লাহ ﷺ এর সাথী কে ছিলেন?',
                options: ['উমর রা.', 'আবু বকর রা.', 'উসমান রা.', 'আলী রা.'],
                correctAnswer: 1
            },
            {
                id: 6,
                type: 'mcq',
                question: 'বদর যুদ্ধ কোন সালে সংঘটিত হয়?',
                options: ['২ হিজরী', '৩ হিজরী', '৪ হিজরী', '৫ হিজরী'],
                correctAnswer: 0
            },
            {
                id: 7,
                type: 'mcq',
                question: 'উহুদ যুদ্ধে রাসূলুল্লাহ ﷺ এর কয়টি দাঁত শহীদ হয়?',
                options: ['১টি', '২টি', '৩টি', '৪টি'],
                correctAnswer: 1
            },
            {
                id: 8,
                type: 'mcq',
                question: 'মক্কা বিজয় কোন সালে হয়?',
                options: ['৬ হিজরী', '৭ হিজরী', '৮ হিজরী', '৯ হিজরী'],
                correctAnswer: 2
            },
            {
                id: 9,
                type: 'short',
                question: 'রাসূলুল্লাহ ﷺ এর মাতার নাম লিখুন।'
            },
            {
                id: 10,
                type: 'short',
                question: 'মি\'রাজ কোন শহর থেকে সংঘটিত হয়েছিল?'
            }
        ];

        // State
        let state = {
            view: 'start',
            participant: { name: '', phone: '' },
            answers: {},
            currentQuestion: 0,
            timeLeft: 60 * 60,
            startTime: null,
            submissions: [],
            timerInterval: null,
            loading: false,
            autoSaveTimeout: null,
            lastSubmission: null
        };

        // WhatsApp এ পাঠানোর function
        function sendToWhatsApp(submission) {
            const message = `
🕌 সীরাতুন নবী ﷺ প্রতিযোগিতা

👤 নাম: ${submission.name}
📱 মোবাইল: ${submission.phone}
🔐 Verification Code: ${submission.verificationCode}

আমার পরীক্ষা সম্পন্ন হয়েছে।
            `.trim();

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodedMessage}`;
            
            return whatsappUrl;
        }

        // Storage functions
        async function saveSubmission(submission) {
            try {
                const allSubs = JSON.parse(localStorage.getItem('sirat_subs') || '[]');
                allSubs.push(submission);
                localStorage.setItem('sirat_subs', JSON.stringify(allSubs));
                state.lastSubmission = submission;
                return true;
            } catch (error) {
                console.error('Save error:', error);
                return false;
            }
        }

        async function loadSubmissions() {
            try {
                const subs = JSON.parse(localStorage.getItem('sirat_subs') || '[]');
                state.submissions = subs;
                return subs;
            } catch (error) {
                console.error('Load error:', error);
                return [];
            }
        }

        // Auto-save functionality
        function autoSave() {
            if (state.view === 'quiz') {
                const progressData = {
                    participant: state.participant,
                    answers: state.answers,
                    currentQuestion: state.currentQuestion,
                    timeLeft: state.timeLeft,
                    startTime: state.startTime
                };
                
                try {
                    localStorage.setItem('quiz_progress', JSON.stringify(progressData));
                    showAutoSaveIndicator('সংরক্ষিত');
                } catch (e) {
                    console.log('Auto-save failed');
                }
            }
        }

        function showAutoSaveIndicator(message) {
            const indicator = document.getElementById('autoSaveIndicator');
            if (indicator) {
                indicator.textContent = '✓ ' + message;
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }

        function loadProgress() {
            try {
                const saved = localStorage.getItem('quiz_progress');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (confirm('আপনার আগের প্রগ্রেস পাওয়া গেছে। এটি চালিয়ে যেতে চান?')) {
                        state.participant = data.participant;
                        state.answers = data.answers;
                        state.currentQuestion = data.currentQuestion;
                        state.timeLeft = data.timeLeft;
                        state.startTime = new Date(data.startTime);
                        state.view = 'quiz';
                        startTimer();
                        render();
                        return true;
                    } else {
                        localStorage.removeItem('quiz_progress');
                    }
                }
            } catch (e) {
                console.log('Could not load progress');
            }
            return false;
        }

        function clearProgress() {
            try {
                localStorage.removeItem('quiz_progress');
            } catch (e) {
                console.log('Could not clear progress');
            }
        }

        // Export functions
        function exportToCSV() {
            if (state.submissions.length === 0) {
                alert('কোনো ডাটা নেই এক্সপোর্ট করার জন্য');
                return;
            }

            let csv = 'নাম,মোবাইল,Code,সঠিক উত্তর,ভুল উত্তর,উত্তরহীন,সময়,জমার তারিখ\n';
            
            state.submissions.forEach(sub => {
                csv += `"${sub.name}","${sub.phone}","${sub.verificationCode}",${sub.mcqCorrect},${sub.mcqWrong},${sub.mcqUnanswered},"${sub.timeTaken}","${sub.submittedAt}"\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'সীরাত_প্রতিযোগিতা_ফলাফল_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        function exportToExcel() {
            if (state.submissions.length === 0) {
                alert('কোনো ডাটা নেই এক্সপোর্ট করার জন্য');
                return;
            }

            const data = state.submissions.map((sub, idx) => ({
                'ক্রমিক': idx + 1,
                'নাম': sub.name,
                'মোবাইল': sub.phone,
                'Code': sub.verificationCode,
                'সঠিক উত্তর': sub.mcqCorrect,
                'ভুল উত্তর': sub.mcqWrong,
                'উত্তরহীন': sub.mcqUnanswered,
                'সময়': sub.timeTaken,
                'জমার তারিখ': sub.submittedAt
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Results');
            
            XLSX.writeFile(wb, 'সীরাত_প্রতিযোগিতা_ফলাফল_' + new Date().toISOString().split('T')[0] + '.xlsx');
        }

        // Format time
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
        }

        // Start quiz
        function startQuiz() {
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            
            if (!name || !phone) {
                alert('দয়া করে নাম ও মোবাইল নম্বর দিন');
                return;
            }
            
            state.participant = { name, phone };
            state.startTime = new Date();
            state.view = 'quiz';
            startTimer();
            autoSave();
            render();
        }

        // Timer
        function startTimer() {
            state.timerInterval = setInterval(() => {
                state.timeLeft--;
                if (state.timeLeft <= 0) {
                    submitQuiz();
                }
                updateTimer();
                
                // Auto-save every 30 seconds
                if (state.timeLeft % 30 === 0) {
                    autoSave();
                }
            }, 1000);
        }

        function updateTimer() {
            const el = document.getElementById('timer');
            if (el) el.textContent = formatTime(state.timeLeft);
        }

        // Submit quiz
        async function submitQuiz() {
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
            }
            
            state.loading = true;
            render();
            
            const endTime = new Date();
            const timeTaken = Math.floor((endTime - state.startTime) / 1000);
            
            const mcqs = QUESTIONS.filter(q => q.type === 'mcq');
            let correct = 0, wrong = 0;
            
            mcqs.forEach(q => {
                if (state.answers[q.id] !== undefined) {
                    if (state.answers[q.id] === q.correctAnswer) {
                        correct++;
                    } else {
                        wrong++;
                    }
                }
            });

            const unanswered = mcqs.length - correct - wrong;
            
            // Generate verification code
            const verificationCode = generateVerificationCode(
                correct, 
                wrong, 
                unanswered, 
                state.participant.phone,
                state.participant.name,
                formatTime(timeTaken)
            );

            const shortAnswers = QUESTIONS
                .filter(q => q.type === 'short')
                .map(q => ({
                    question: q.question,
                    answer: state.answers[q.id] || 'উত্তর দেননি'
                }));

            const submission = {
                name: state.participant.name,
                phone: state.participant.phone,
                verificationCode: verificationCode,
                mcqCorrect: correct,
                mcqWrong: wrong,
                mcqUnanswered: unanswered,
                shortAnswers: shortAnswers,
                timeTaken: formatTime(timeTaken),
                submittedAt: new Date().toLocaleString('bn-BD'),
                timestamp: Date.now()
            };

            const saved = await saveSubmission(submission);
            
            if (saved) {
                clearProgress();
                state.loading = false;
                state.view = 'submitted';
            } else {
                state.loading = false;
                alert('জমা দিতে সমস্যা হয়েছে। আবার চেষ্টা করুন।');
            }
            
            render();
        }

        // Answer functions
        function selectAnswer(questionId, answerIndex) {
            state.answers[questionId] = answerIndex;
            autoSave();
            render();
        }

        function updateShortAnswer(questionId) {
            const el = document.getElementById('shortAnswer');
            if (el) {
                state.answers[questionId] = el.value;
                
                // Debounced auto-save
                if (state.autoSaveTimeout) {
                    clearTimeout(state.autoSaveTimeout);
                }
                state.autoSaveTimeout = setTimeout(() => {
                    autoSave();
                }, 1000);
            }
        }

        // Navigation
        function nextQuestion() {
            if (state.currentQuestion < QUESTIONS.length - 1) {
                state.currentQuestion++;
                autoSave();
                render();
            }
        }

        function prevQuestion() {
            if (state.currentQuestion > 0) {
                state.currentQuestion--;
                render();
            }
        }

        function goToStart() {
            state.view = 'start';
            state.currentQuestion = 0;
            state.answers = {};
            state.timeLeft = 60 * 60;
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
            }
            render();
        }

        async function showAdmin() {
            const pass = prompt('অ্যাডমিন পাসওয়ার্ড:');
            if (pass === 'admin123') {
                state.view = 'admin';
                state.loading = true;
                render();
                await loadSubmissions();
                state.loading = false;
                render();
            } else {
                alert('ভুল পাসওয়ার্ড');
            }
        }

        // Decode function for admin
        function decodeCode() {
            const input = document.getElementById('decodeInput');
            const result = document.getElementById('decodeResult');
            
            if (!input || !result) return;
            
            const code = input.value.trim();
            if (!code) {
                alert('দয়া করে একটি Code দিন');
                return;
            }
            
            console.log('=== DECODING START ===');
            console.log('Original code:', code);
            
            const decoded = decodeVerificationCode(code);
            
            console.log('Decoded result:', decoded);
            if (decoded) {
                console.log('Name:', decoded.name);
                console.log('Phone:', decoded.phone);
                console.log('Correct:', decoded.correct);
                console.log('Wrong:', decoded.wrong);
                console.log('Unanswered:', decoded.unanswered);
                console.log('Time:', decoded.time);
            }
            console.log('=== DECODING END ===');
            
            if (decoded && decoded.name && decoded.phone) {
                result.innerHTML = `
                    <div style="background: #d1fae5; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h4 style="color: #065f46; margin-bottom: 10px;">✅ Code Successfully Decoded!</h4>
                    </div>
                    <div class="result-item">
                        <strong>👤 নাম:</strong> ${decoded.name || 'N/A'}
                    </div>
                    <div class="result-item">
                        <strong>📱 মোবাইল:</strong> ${decoded.phone || 'N/A'}
                    </div>
                    <div class="result-item">
                        <strong>✅ সঠিক উত্তর:</strong> ${decoded.correct}
                    </div>
                    <div class="result-item">
                        <strong>❌ ভুল উত্তর:</strong> ${decoded.wrong}
                    </div>
                    <div class="result-item">
                        <strong>⚪ উত্তরহীন:</strong> ${decoded.unanswered}
                    </div>
                    <div class="result-item">
                        <strong>⏱️ সময়:</strong> ${decoded.time || 'N/A'}
                    </div>
                    <div class="result-item">
                        <strong>🔐 Code:</strong> <span style="font-family: monospace; background: #f3f4f6; padding: 5px 10px; border-radius: 5px; word-break: break-all;">${decoded.code}</span>
                    </div>
                `;
                result.classList.add('show');
            } else {
                result.innerHTML = `
                    <div style="background: #fee2e2; padding: 15px; border-radius: 10px;">
                        <h4 style="color: #991b1b; margin-bottom: 10px;">❌ Decode Failed!</h4>
                        <p style="color: #991b1b;">Code decode হতে পারেনি। Console দেখুন বিস্তারিত error এর জন্য।</p>
                        ${decoded ? `<p style="margin-top:10px; color:#991b1b; font-size:14px;">Name: ${decoded.name}, Phone: ${decoded.phone}</p>` : ''}
                    </div>
                `;
                result.classList.add('show');
            }
        }

        // Render functions
        function renderStart() {
            return `
                <div class="container">
                    <div class="card">
                        <h1>সীরাতুন নবী ﷺ প্রতিযোগিতা</h1>
                        <p class="subtitle">রাসূলুল্লাহ ﷺ এর জীবনী নিয়ে জ্ঞান প্রতিযোগিতা</p>
                        
                        <div class="info-box">
                            <h3>প্রতিযোগিতার বিবরণ:</h3>
                            <ul>
                                <li>📝 মোট প্রশ্ন: ১০টি (৮টি MCQ + ২টি সংক্ষিপ্ত)</li>
                                <li>⏰ সময়: ১ ঘন্টা (৬০ মিনিট)</li>
                                <li>✅ একবার শুরু করলে থামানো যাবে না</li>
                                <li>💾 আপনার উত্তর স্বয়ংক্রিয়ভাবে সংরক্ষিত হবে</li>
                                <li>🔐 পরীক্ষা শেষে একটি Verification Code পাবেন</li>
                                <li>📱 Code সহ WhatsApp এ ফলাফল পাঠান</li>
                                <li>🎯 সব প্রশ্নের উত্তর দেওয়ার চেষ্টা করুন</li>
                            </ul>
                        </div>

                        <div class="form-group">
                            <label>👤 আপনার নাম *</label>
                            <input type="text" id="name" placeholder="পূর্ণ নাম লিখুন">
                        </div>

                        <div class="form-group">
                            <label>📱 মোবাইল নম্বর *</label>
                            <input type="tel" id="phone" placeholder="০১XXXXXXXXX">
                        </div>

                        <button class="btn btn-primary" onclick="startQuiz()">
                            প্রতিযোগিতা শুরু করুন
                        </button>

                        <div class="admin-link">
                            <button onclick="showAdmin()">অ্যাডমিন প্যানেল</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderQuiz() {
            if (state.loading) {
                return '<div class="loading">জমা হচ্ছে...</div>';
            }

            const q = QUESTIONS[state.currentQuestion];
            const progress = ((state.currentQuestion + 1) / QUESTIONS.length) * 100;

            let optionsHTML = '';
            if (q.type === 'mcq') {
                optionsHTML = q.options.map((opt, idx) => {
                    const selected = state.answers[q.id] === idx ? 'selected' : '';
                    return `
                        <button class="option ${selected}" onclick="selectAnswer(${q.id}, ${idx})">
                            <strong>${String.fromCharCode(65 + idx)}.</strong> ${opt}
                        </button>
                    `;
                }).join('');
            } else {
                const val = state.answers[q.id] || '';
                optionsHTML = `
                    <textarea id="shortAnswer" oninput="updateShortAnswer(${q.id})" 
                              rows="4" style="width:100%; padding:15px; border:2px solid #d1d5db; border-radius:10px;"
                              placeholder="এখানে আপনার উত্তর লিখুন...">${val}</textarea>
                `;
            }

            return `
                <div class="container">
                    <div class="timer-box">
                        <div class="timer-header">
                            <div style="color:#065f46; font-weight:bold;">
                                প্রশ্ন ${state.currentQuestion + 1} / ${QUESTIONS.length}
                            </div>
                            <div class="timer">
                                ⏰ <span id="timer">${formatTime(state.timeLeft)}</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width:${progress}%"></div>
                        </div>
                    </div>

                    <div class="question-card">
                        <span class="question-badge">
                            ${q.type === 'mcq' ? 'বহুনির্বাচনী' : 'সংক্ষিপ্ত উত্তর'}
                        </span>
                        <div class="question-text">${q.question}</div>
                        ${optionsHTML}
                    </div>

                    <div class="nav-buttons">
                        <button class="btn btn-secondary" onclick="prevQuestion()" 
                                ${state.currentQuestion === 0 ? 'disabled' : ''}>
                            পূর্ববর্তী
                        </button>
                        ${state.currentQuestion < QUESTIONS.length - 1 ? `
                            <button class="btn btn-primary" onclick="nextQuestion()">
                                পরবর্তী প্রশ্ন
                            </button>
                        ` : `
                            <button class="btn btn-danger" onclick="submitQuiz()">
                                জমা দিন
                            </button>
                        `}
                    </div>
                </div>
            `;
        }

        function renderSubmitted() {
            const whatsappUrl = sendToWhatsApp(state.lastSubmission);
            const displayNumber = WHATSAPP_NUMBER.replace('88', '').replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            
            return `
                <div class="container" style="margin-top:50px;">
                    <div class="card">
                        <div class="success-icon">✅</div>
                        <div class="success-message">
                            <h2>জমা সফল হয়েছে!</h2>
                            <p>${state.participant.name}, আপনার উত্তরপত্র সফলভাবে জমা হয়েছে।</p>
                            
                            <div class="code-box">
                                <div class="code-label">🔐 আপনার Verification Code</div>
                                <div class="verification-code">${state.lastSubmission.verificationCode}</div>
                                <div class="code-instruction">এই Code টি সংরক্ষণ করুন এবং WhatsApp এ পাঠান</div>
                            </div>

                            <div class="whatsapp-box">
                                <h3>📱 WhatsApp এ Code পাঠান</h3>
                                <p style="color: #6b7280; margin: 10px 0;">
                                    নিচের বাটনে ক্লিক করে আপনার Code পাঠান
                                </p>
                                <div class="whatsapp-number">${displayNumber}</div>
                                <button class="btn btn-whatsapp" onclick="window.open('${whatsappUrl}', '_blank')" style="margin-top: 15px;">
                                    <span style="font-size: 24px;">📱</span>
                                    WhatsApp এ পাঠান
                                </button>
                            </div>

                            <p style="color:#6b7280; margin-top:30px; font-size: 14px;">
                                আল্লাহ আপনাকে উত্তম প্রতিদান দিন। 🤲
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdmin() {
            if (state.loading) {
                return '<div class="loading">লোড হচ্ছে...</div>';
            }

            const rows = state.submissions
                .sort((a, b) => b.timestamp - a.timestamp)
                .map((sub, idx) => `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${sub.name}</td>
                        <td>${sub.phone}</td>
                        <td style="font-family: monospace;">${sub.verificationCode}</td>
                        <td><span class="badge badge-green">${sub.mcqCorrect}</span></td>
                        <td><span class="badge badge-red">${sub.mcqWrong}</span></td>
                        <td><span class="badge badge-gray">${sub.mcqUnanswered}</span></td>
                        <td>${sub.timeTaken}</td>
                        <td style="font-size:12px;">${sub.submittedAt}</td>
                    </tr>
                `).join('');

            return `
                <div class="container" style="max-width:1200px;">
                    <div class="card">
                        <div class="admin-header">
                            <div>
                                <h2>অ্যাডমিন প্যানেল</h2>
                                <p style="color:#6b7280;">মোট জমা: ${state.submissions.length}টি</p>
                            </div>
                            <button class="btn btn-secondary" onclick="goToStart()">প্রস্থান</button>
                        </div>

                                                    <div class="decoder-box">
                            <h3>🔍 Verification Code Decoder</h3>
                            <p style="color: #6b7280; margin-bottom: 10px;">
                                Code পেস্ট করুন - এতে নাম, ফোন, result, সময় সব encoded আছে
                            </p>
                            <p style="color: #6b7280; margin-bottom: 10px; font-size: 13px;">
                                📌 Format: EncodedNamePhone-ResultCode-TimeCode<br>
                                📌 BACKGROUND: B=0, A=1, C=2, K=3, G=4, R=5, O=6, U=7, N=8, D=9<br>
                                📌 Console খুলে error দেখুন (F12 চাপুন)
                            </p>
                            <div class="decode-input">
                                <input type="text" id="decodeInput" placeholder="Code এখানে paste করুন..." style="font-size: 14px; text-transform: none;">
                                <button class="btn btn-decode" onclick="decodeCode()">Decode</button>
                            </div>
                            <div id="decodeResult" class="decode-result"></div>
                        </div>

                        <div class="export-buttons">
                            <button class="btn btn-success" onclick="exportToExcel()">
                                📊 Excel এ ডাউনলোড করুন
                            </button>
                            <button class="btn btn-primary" onclick="exportToCSV()">
                                📄 CSV এ ডাউনলোড করুন
                            </button>
                        </div>
                    </div>

                    <div class="card" style="padding:0; overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>নাম</th>
                                    <th>মোবাইল</th>
                                    <th>Code</th>
                                    <th>সঠিক</th>
                                    <th>ভুল</th>
                                    <th>উত্তরহীন</th>
                                    <th>সময়</th>
                                    <th>জমার সময়</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows || '<tr><td colspan="9" style="text-align:center; padding:40px; color:#9ca3af;">এখনো কোনো জমা নেই</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            
            if (state.view === 'start') {
                app.innerHTML = renderStart();
            } else if (state.view === 'quiz') {
                app.innerHTML = renderQuiz();
            } else if (state.view === 'submitted') {
                app.innerHTML = renderSubmitted();
            } else if (state.view === 'admin') {
                app.innerHTML = renderAdmin();
            }
        }

        // Initialize
        window.onload = function() {
            // Try to load saved progress
            if (!loadProgress()) {
                render();
            }
        };
    </script>
</body>
</html>
